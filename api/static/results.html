<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Research Pro - Results</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/results.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'><path d='M12 2L1 12h3v9h6v-6h4v6h6v-9h3L12 2z'/></svg>">
</head>
<body>
    <div class="particle-bg" id="particleBg"></div>

    <div class="comparison-bar" id="comparisonBar">
        <div class="comparison-items" id="comparisonItems"></div>
        <button class="compare-now-button" id="compareNowButton">Compare Now (0)</button>
        <button class="clear-comparison" id="clearComparison">
            <svg viewBox="0 0 24 24">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </button>
    </div>

    <div class="comparison-modal" id="comparisonModal">
        <div class="comparison-modal-content">
            <button class="close-modal" id="closeModal">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <h2>Product Comparison</h2>
            <div class="comparison-table-container">
                <table class="comparison-table" id="comparisonTable">
                    <thead>
                        <tr>
                            <th>Feature</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <header class="results-header">
        <div class="back-button" onclick="window.history.back()">
            <svg viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Back to search
        </div>
        <h1>Search Results</h1>
        <p id="searchQuery"></p>
    </header>

    <main class="results-container">
        <div class="stats-container">
            <div class="stats-card">
                <div class="stats-value" id="productsCount">0</div>
                <div class="stats-label">Products Found</div>
            </div>
            <div class="stats-card">
                <div class="stats-value" id="priceRange">$0 - $0</div>
                <div class="stats-label">Price Range</div>
            </div>
            <div class="stats-card best-choice">
                <div class="stats-value" id="bestProduct">None</div>
                <div class="stats-label">Best Choice</div>
            </div>
            <div class="stats-card ai-recommendation">
                <div class="stats-value" id="aiRecommendation">Analyzing...</div>
                <div class="stats-label">AI Recommendation</div>
            </div>
        </div>

        <div class="filters">
            <select id="sortBy">
                <option value="rating">Sort by: Rating</option>
                <option value="price_asc">Price: Low to High</option>
                <option value="price_desc">Price: High to Low</option>
            </select>
            <div class="filter-tags" id="filterTags"></div>
        </div>

        <div class="products-grid" id="productsGrid">
            <!-- Products will be inserted here by JavaScript -->
        </div>
    </main>

    <button class="ai-chat-btn" id="aiChatButton">
        <i class="fas fa-robot"></i>
    </button>

    <div class="footer-container" id="footerContainer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="#" aria-label="Home">Home</a>
                <a href="#" aria-label="Features">Features</a>
                <a href="#" aria-label="Documentation">Docs</a>
                <a href="#" aria-label="Contact">Contact</a>
            </div>
            <div class="footer-social">
                <a href="#" class="social-icon" aria-label="Twitter">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
                    </svg>
                </a>
                <a href="#" class="social-icon" aria-label="GitHub">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
                    </svg>
                </a>
                <a href="#" class="social-icon" aria-label="LinkedIn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
                        <rect x="2" y="9" width="4" height="12"/>
                        <circle cx="4" cy="4" r="2"/>
                    </svg>
                </a>
            </div>
            <p class="copyright">© 2023 AI Research Pro. All rights reserved.</p>
        </div>
    </div>

    <div class="scroll-arrow" id="toggleFooter">
        <svg viewBox="0 0 24 24">
            <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
        </svg>
    </div>

    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-header">
            <h3>AI Assistant</h3>
            <button class="close-chat" id="closeChat">
                <svg viewBox="0 0 24 24" width="18" height="18">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask about products...">
            <button id="sendMessage">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Variables globales
        let selectedProducts = [];
        let allProducts = [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let archived = JSON.parse(localStorage.getItem('archived')) || [];
        let socket;

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize particles
            const particleBg = document.getElementById('particleBg');
            const particleCount = window.innerWidth < 768 ? 20 : 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${10 + Math.random() * 20}s`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particleBg.appendChild(particle);
            }

            // Toggle footer - Fixed version
            const toggleFooter = document.getElementById('toggleFooter');
            const footerContainer = document.getElementById('footerContainer');
            const footerHeight = footerContainer.offsetHeight;

            toggleFooter.addEventListener('click', function() {
                const isVisible = footerContainer.classList.toggle('visible');
                this.classList.toggle('visible');
                
                if (isVisible) {
                    this.style.transform = `translateX(-50%) translateY(-${footerHeight + 20}px)`;
                    this.querySelector('svg').style.transform = 'rotate(180deg)';
                } else {
                    this.style.transform = 'translateX(-50%)';
                    this.querySelector('svg').style.transform = 'rotate(0deg)';
                }
            });

            // Get search query from URL
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query');
            const top_n = urlParams.get('top_n') || 10;
            document.getElementById('searchQuery').textContent = `Showing results for: "${query}" (maximum ${top_n} products)`;

            // Load products
            try {
                showLoading(true);
                const products = await fetchProducts(query);
                allProducts = products;
                displayResults(products);
                await getAIRecommendation(products);
            } catch (error) {
                console.error('Error loading products:', error);
                showError('Failed to load products. Showing sample results...');
                allProducts = mockSpecialCharResults();
                displayResults(allProducts);
            } finally {
                showLoading(false);
            }

            // Sort functionality
            document.getElementById('sortBy').addEventListener('change', (e) => {
                const sortedProducts = sortProducts([...allProducts], e.target.value);
                displayResults(sortedProducts);
            });

            // Comparison bar functionality
            const compareNowButton = document.getElementById('compareNowButton');
            const clearComparisonButton = document.getElementById('clearComparison');
            const closeModalButton = document.getElementById('closeModal');
            const comparisonModal = document.getElementById('comparisonModal');

            compareNowButton.addEventListener('click', showComparisonModal);
            clearComparisonButton.addEventListener('click', clearComparison);
            closeModalButton.addEventListener('click', () => {
                comparisonModal.style.display = 'none';
            });

            // Close modal when clicking outside
            comparisonModal.addEventListener('click', (e) => {
                if (e.target === comparisonModal) {
                    comparisonModal.style.display = 'none';
                }
            });

            // Setup chat functionality
            setupChat();
        });

        // Chat functions
        function setupChat() {
            const chatButton = document.getElementById('aiChatButton');
            const chatSidebar = document.getElementById('chatSidebar');
            const closeChat = document.getElementById('closeChat');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendMessage');

            chatButton.addEventListener('click', toggleChat);
            closeChat.addEventListener('click', toggleChat);
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            function toggleChat() {
                chatSidebar.classList.toggle('active');
                if (chatSidebar.classList.contains('active')) {
                    connectWebSocket();
                } else if (socket) {
                    socket.close();
                }
            }

            function connectWebSocket() {
                socket = new WebSocket(`ws://${window.location.host}/ws_assistant`);
                
                socket.onopen = (e) => {
                    addMessage("assistant", "Hello! I'm your AI research assistant. Ask me about these products.");
                };
                
                socket.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    addMessage("assistant", data.assistant_message);
                };
                
                socket.onerror = (e) => {
                    addMessage("assistant", "Sorry, I'm having trouble connecting. Please try again later.");
                };
            }

            function addMessage(sender, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function sendMessage() {
                const message = chatInput.value.trim();
                if (message && socket) {
                    addMessage("user", message);
                    socket.send(message);
                    chatInput.value = '';
                }
            }
        }

        async function fetchProducts(query) {
            try {
                if (!query) {
                    throw new Error('Empty search query');
                }
                
                const encodedQuery = encodeURIComponent(query);
                const response = await fetch(`/scrape?product_name=${encodedQuery}&top_n=10`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return processProductData(data);
            } catch (error) {
                console.error("Fetch error:", error);
                throw error;
            }
        }

        function processProductData(products) {
            if (!products || !Array.isArray(products)) {
                return mockSpecialCharResults();
            }
            
            return products.map(product => {
                return {
                    id: product.id || `temp-${Math.random().toString(36).substring(2, 9)}`,
                    name: product.title || "Unnamed Product",
                    price: parseFloat(product.price || 0),
                    rating: parseFloat(product.rating || 0),
                    features: product.features || ["No features specified"],
                    link: product.url || "#",
                    source: product.source || "Unknown Source",
                    image: product.image || "https://via.placeholder.com/300x200?text=No+Image",
                    lastUpdated: product.lastUpdated || "Unknown",
                    specs: product.specs || {
                        weight: "N/A",
                        dimensions: "N/A"
                    },
                    store: product.store || "Unknown Store",
                    currency: product.currency || "USD"
                };
            });
        }

        function mockSpecialCharResults() {
            return [
                {
                    id: "ex-1",
                    name: "Test Product (Sample)",
                    price: 29.99,
                    rating: 4.5,
                    features: ["Waterproof", "Wireless", "Battery life: 24h"],
                    link: "#",
                    source: "Example Source",
                    image: "https://via.placeholder.com/300x200?text=Test+Product",
                    lastUpdated: "Just now",
                    specs: {
                        weight: "0.5kg",
                        dimensions: "10x5x3 cm"
                    },
                    store: "Example Store",
                    currency: "USD"
                },
                {
                    id: "ex-2",
                    name: "Demo Item (Sample)",
                    price: 49.99,
                    rating: 3.8,
                    features: ["Ergonomic design", "Adjustable", "3 colors available"],
                    link: "#",
                    source: "Demo Source",
                    image: "https://via.placeholder.com/300x200?text=Demo+Item",
                    lastUpdated: "Just now",
                    specs: {
                        weight: "0.8kg",
                        dimensions: "15x10x5 cm"
                    },
                    store: "Demo Store",
                    currency: "USD"
                }
            ];
        }

        async function getAIRecommendation(products) {
            return new Promise(resolve => {
                setTimeout(() => {
                    if (products.length === 0) {
                        document.getElementById('aiRecommendation').textContent = "No products to recommend";
                        return resolve();
                    }
                    
                    const bestProduct = products.reduce((a, b) => {
                        const scoreA = (a.rating * 0.5) - ((a.price / 1000) * 0.2);
                        const scoreB = (b.rating * 0.5) - ((b.price / 1000) * 0.2);
                        return scoreA > scoreB ? a : b;
                    });
                    
                    document.getElementById('aiRecommendation').textContent = 
                        `"${bestProduct.name}" - Best value for money`;
                    resolve();
                }, 1200);
            });
        }

        function sortProducts(products, sortBy) {
            switch(sortBy) {
                case 'rating':
                    return products.sort((a, b) => b.rating - a.rating);
                case 'price_asc':
                    return products.sort((a, b) => a.price - b.price);
                case 'price_desc':
                    return products.sort((a, b) => b.price - a.price);
                default:
                    return products;
            }
        }

        function displayResults(products) {
            const productsGrid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                productsGrid.innerHTML = `
                    <div class="no-results">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                        <h3>No products found</h3>
                        <p>Try adjusting your search query or filters</p>
                    </div>
                `;
                return;
            }

            // Update summary
            document.getElementById('productsCount').textContent = products.length;
            
            const prices = products.map(p => p.price);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            document.getElementById('priceRange').textContent = `$${minPrice.toFixed(2)} - $${maxPrice.toFixed(2)}`;
            
            const bestProduct = products.reduce((prev, current) => 
                (prev.rating > current.rating) ? prev : current);
            document.getElementById('bestProduct').textContent = bestProduct.name;

            // Display products
            productsGrid.innerHTML = '';
            
            products.forEach(product => {
                const isBest = product === bestProduct;
                const isSelected = selectedProducts.some(p => p.id === product.id);
                const isFavorite = favorites.some(p => p.id === product.id);
                const isArchived = archived.some(p => p.id === product.id);
                
                const productCard = document.createElement('div');
                productCard.className = `product-card ${isBest ? 'best-product' : ''} ${isSelected ? 'selected' : ''}`;
                productCard.dataset.id = product.id;
                
                productCard.innerHTML = `
                    ${isBest ? '<div class="product-badge">⭐ Best Choice</div>' : ''}
                    <div class="product-image-container">
                        <img src="${product.image}" alt="${product.name}" class="product-image" 
                             onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                        <div class="product-source">${product.source}</div>
                    </div>
                    <div class="product-info-content">
                        <h3>${product.name}</h3>
                        <div class="product-meta">
                            <div class="product-rating">
                                ${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}
                                <span>${product.rating}</span>
                            </div>
                            <div class="product-store">${product.store}</div>
                        </div>
                        <div class="product-price">${product.currency} ${product.price.toFixed(2)}</div>
                        
                        ${product.features && product.features.length > 0 ? `
                        <div class="product-features-section">
                            <h4>Key Features:</h4>
                            <ul class="product-features">
                                ${product.features.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        <div class="product-actions">
                            <a href="${product.link}" target="_blank" class="buy-button">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor">
                                    <path d="M16 11V7a4 4 0 0 0-8 0v4M5 9h14l1 12H4L5 9z"/>
                                </svg>
                                View Product
                            </a>
                            <button class="compare-button ${isSelected ? 'selected' : ''}" data-id="${product.id}">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor">
                                    <path d="M4 5h16M4 12h16M4 19h16"/>
                                </svg>
                                ${isSelected ? 'Added' : 'Compare'}
                            </button>
                        </div>
                        
                        <div class="product-actions-extended">
                            <button class="action-button favorite-btn ${isFavorite ? 'active' : ''}" data-id="${product.id}">
                                <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
                                Favorite
                            </button>
                            <button class="action-button archive-btn ${isArchived ? 'active' : ''}" data-id="${product.id}">
                                <i class="${isArchived ? 'fas' : 'far'} fa-folder"></i>
                                Archive
                            </button>
                            <button class="action-button share-btn" data-id="${product.id}">
                                <i class="fas fa-share-alt"></i>
                                Share
                            </button>
                        </div>
                    </div>
                `;
                
                productsGrid.appendChild(productCard);
            });

            // Add event listeners
            document.querySelectorAll('.compare-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const productId = e.target.getAttribute('data-id');
                    toggleProductComparison(productId);
                });
            });
            
            document.querySelectorAll('.favorite-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.currentTarget.getAttribute('data-id');
                    toggleFavorite(productId);
                });
            });
            
            document.querySelectorAll('.archive-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.currentTarget.getAttribute('data-id');
                    toggleArchive(productId);
                });
            });
            
            document.querySelectorAll('.share-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.currentTarget.getAttribute('data-id');
                    shareProduct(productId);
                });
            });
        }

        function toggleProductComparison(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            const index = selectedProducts.findIndex(p => p.id === productId);
            const button = document.querySelector(`.compare-button[data-id="${productId}"]`);
            
            if (index === -1) {
                if (selectedProducts.length < 4) {
                    selectedProducts.push(product);
                    button.textContent = 'Added';
                    button.classList.add('selected');
                    button.closest('.product-card').classList.add('selected');
                    showToast('Added to comparison');
                } else {
                    showToast('Maximum 4 products can be compared');
                }
            } else {
                selectedProducts.splice(index, 1);
                button.textContent = 'Compare';
                button.classList.remove('selected');
                button.closest('.product-card').classList.remove('selected');
                showToast('Removed from comparison');
            }
            
            updateComparisonBar();
        }

        function toggleFavorite(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            const index = favorites.findIndex(p => p.id === productId);
            const btn = document.querySelector(`.favorite-btn[data-id="${productId}"] i`);
            
            if (index === -1) {
                favorites.push(product);
                btn.classList.replace('far', 'fas');
                btn.classList.add('active');
                showToast('Added to favorites');
            } else {
                favorites.splice(index, 1);
                btn.classList.replace('fas', 'far');
                btn.classList.remove('active');
                showToast('Removed from favorites');
            }
            
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        function toggleArchive(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            const index = archived.findIndex(p => p.id === productId);
            const btn = document.querySelector(`.archive-btn[data-id="${productId}"] i`);
            
            if (index === -1) {
                archived.push(product);
                btn.classList.replace('far', 'fas');
                btn.classList.add('active');
                showToast('Product archived');
            } else {
                archived.splice(index, 1);
                btn.classList.replace('fas', 'far');
                btn.classList.remove('active');
                showToast('Product unarchived');
            }
            
            localStorage.setItem('archived', JSON.stringify(archived));
        }

        function shareProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            if (navigator.share) {
                navigator.share({
                    title: product.name,
                    text: `Check out this product: ${product.name}`,
                    url: product.link
                }).catch(err => {
                    console.log('Error sharing:', err);
                    copyToClipboard(product.link);
                });
            } else {
                copyToClipboard(product.link);
            }
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('Link copied to clipboard');
        }

        function updateComparisonBar() {
            const comparisonBar = document.getElementById('comparisonBar');
            const comparisonItems = document.getElementById('comparisonItems');
            const compareNowButton = document.getElementById('compareNowButton');
            
            comparisonItems.innerHTML = '';
            
            if (selectedProducts.length > 0) {
                comparisonBar.classList.add('active');
                compareNowButton.textContent = `Compare Now (${selectedProducts.length})`;
                
                selectedProducts.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'comparison-item';
                    item.innerHTML = `
                        <img src="${product.image}" alt="${product.name}">
                        <span>${product.name}</span>
                        <button class="remove-comparison-item" data-id="${product.id}">
                            <svg viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    `;
                    comparisonItems.appendChild(item);
                });
                
                // Add remove item functionality
                document.querySelectorAll('.remove-comparison-item').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const productId = e.target.closest('button').getAttribute('data-id');
                        removeFromComparison(productId);
                    });
                });
            } else {
                comparisonBar.classList.remove('active');
            }
        }

        function removeFromComparison(productId) {
            selectedProducts = selectedProducts.filter(p => p.id !== productId);
            
            // Update UI
            const productCard = document.querySelector(`.product-card[data-id="${productId}"]`);
            if (productCard) {
                productCard.classList.remove('selected');
                const button = productCard.querySelector('.compare-button');
                if (button) {
                    button.textContent = 'Compare';
                    button.classList.remove('selected');
                }
            }
            
            updateComparisonBar();
            showToast('Product removed from comparison');
        }

        function clearComparison() {
            selectedProducts = [];
            updateComparisonBar();
            
            // Update all compare buttons
            document.querySelectorAll('.compare-button.selected').forEach(button => {
                button.textContent = 'Compare';
                button.classList.remove('selected');
                button.closest('.product-card').classList.remove('selected');
            });
            
            showToast('Comparison cleared');
        }

        function showComparisonModal() {
            if (selectedProducts.length < 2) {
                showToast('Please select at least 2 products to compare');
                return;
            }
            
            const comparisonModal = document.getElementById('comparisonModal');
            const comparisonTable = document.getElementById('comparisonTable');
            
            // Clear previous content
            comparisonTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Feature</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            
            // Add product columns to header
            const headerRow = comparisonTable.querySelector('thead tr');
            selectedProducts.forEach(product => {
                const th = document.createElement('th');
                th.innerHTML = `
                    <div class="comparison-product-header">
                        <img src="${product.image}" alt="${product.name}">
                        <h4>${product.name}</h4>
                        <div class="comparison-product-price">${product.currency} ${product.price.toFixed(2)}</div>
                        <div class="comparison-product-rating">
                            ${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))} (${product.rating})
                        </div>
                    </div>
                `;
                headerRow.appendChild(th);
            });
            
            // Add rows for each feature
            const tbody = comparisonTable.querySelector('tbody');
            
            // Price
            addComparisonRow(tbody, 'Price', selectedProducts.map(p => `${p.currency} ${p.price.toFixed(2)}`));
            
            // Rating
            addComparisonRow(tbody, 'Rating', selectedProducts.map(p => p.rating));
            
            // Store
            addComparisonRow(tbody, 'Store', selectedProducts.map(p => p.store));
            
            // Features
            const allFeatures = new Set();
            selectedProducts.forEach(p => {
                if (p.features && p.features.length) {
                    p.features.forEach(f => allFeatures.add(f));
                }
            });
            
            allFeatures.forEach(feature => {
                const values = selectedProducts.map(p => 
                    (p.features && p.features.includes(feature)) ? '✓' : '✗'
                );
                addComparisonRow(tbody, feature, values);
            });
            
            // Show modal
            comparisonModal.style.display = 'flex';
        }

        function addComparisonRow(tbody, featureName, values) {
            const row = document.createElement('tr');
            
            const featureCell = document.createElement('td');
            featureCell.textContent = featureName;
            row.appendChild(featureCell);
            
            values.forEach(value => {
                const valueCell = document.createElement('td');
                valueCell.innerHTML = value;
                if (value === '✓') {
                    valueCell.dataset.value = '✓';
                } else if (value === '✗') {
                    valueCell.dataset.value = '✗';
                }
                row.appendChild(valueCell);
            });
            
            tbody.appendChild(row);
        }

        function showLoading(show) {
            const loader = document.getElementById('loadingIndicator');
            if (show) {
                if (!loader) {
                    const loaderElement = document.createElement('div');
                    loaderElement.id = 'loadingIndicator';
                    loaderElement.className = 'loading-indicator';
                    loaderElement.innerHTML = `
                        <div class="loading-spinner"></div>
                        <p>Loading products...</p>
                    `;
                    document.body.appendChild(loaderElement);
                }
            } else {
                if (loader) {
                    loader.remove();
                }
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            if (!errorContainer) {
                const errorElement = document.createElement('div');
                errorElement.id = 'errorContainer';
                errorElement.className = 'error-message';
                errorElement.innerHTML = `
                    <svg viewBox="0 0 24 24">
                        <path d="M11 15h2v2h-2zm0-8h2v6h-2zm1-5C6.47 2 2 6.5 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2m0 18a8 8 0 0 1-8-8 8 8 0 0 1 8-8 8 8 0 0 1 8 8 8 8 0 0 1-8 8"/>
                    </svg>
                    <p>${message}</p>
                `;
                document.body.appendChild(errorElement);
                setTimeout(() => errorElement.remove(), 5000);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>